{
  "name": "Ruby ActiveRecord Error Rules",
  "description": "Rules for detecting and fixing common Ruby ActiveRecord ORM errors",
  "version": "0.1.0",
  "rules": [
    {
      "id": "activerecord_record_not_found",
      "pattern": "ActiveRecord::RecordNotFound: Couldn't find ([A-Za-z:]+) with( '?\\w+'? = |ID(\\s+or\\s+\\w+ID)?\\s+).+",
      "type": "ActiveRecord::RecordNotFound",
      "description": "Attempted to find a record that doesn't exist",
      "root_cause": "rails_record_not_found",
      "suggestion": "Use find_by or where methods with appropriate error handling. Consider using find_by_id which returns nil instead of raising an exception.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_rollback",
      "pattern": "ActiveRecord::Rollback",
      "type": "ActiveRecord::Rollback",
      "description": "Transaction was rolled back",
      "root_cause": "activerecord_rollback",
      "suggestion": "Ensure all database operations within the transaction are valid. Check for raise ActiveRecord::Rollback statements that may be causing the rollback.",
      "confidence": "medium",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_attribute_assignment_error",
      "pattern": "ActiveModel::AttributeAssignmentError: unknown attribute '([^']+)' for ([A-Za-z:]+)",
      "type": "ActiveModel::AttributeAssignmentError",
      "description": "Attempted to assign to an unknown attribute",
      "root_cause": "activerecord_unknown_attribute",
      "suggestion": "Check for typos in attribute names. Ensure you've run migrations to add the column. For virtual attributes, define them with attr_accessor.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_not_null_violation",
      "pattern": "ActiveRecord::NotNullViolation: (.*column|field) \"([^\"]+)\" (cannot|violates not-null constraint)",
      "type": "ActiveRecord::NotNullViolation",
      "description": "Attempted to insert a null value into a column with a NOT NULL constraint",
      "root_cause": "activerecord_not_null_violation",
      "suggestion": "Ensure required fields have values before saving. Add presence validations to your model for NOT NULL columns.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_connection_not_established",
      "pattern": "ActiveRecord::ConnectionNotEstablished",
      "type": "ActiveRecord::ConnectionNotEstablished",
      "description": "Database connection could not be established",
      "root_cause": "activerecord_connection_not_established",
      "suggestion": "Check database configuration in database.yml. Ensure the database server is running and accessible.",
      "confidence": "high",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_stmt_prepared",
      "pattern": "ActiveRecord::StatementInvalid: (?:PG::)?(?:InFailedSqlTransaction|TransactionRollbackException)",
      "type": "ActiveRecord::StatementInvalid",
      "description": "SQL statement failed due to a prior error in the transaction",
      "root_cause": "activerecord_transaction_rollback",
      "suggestion": "Check earlier errors in the transaction. Ensure all database operations are valid. Use transaction callbacks for cleanup.",
      "confidence": "medium",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_readonly_attributes",
      "pattern": "ActiveRecord::ReadOnlyAttributeError: can't write readonly attribute: ([^\\s]+)",
      "type": "ActiveRecord::ReadOnlyAttributeError",
      "description": "Attempted to modify a readonly attribute",
      "root_cause": "activerecord_readonly_attribute",
      "suggestion": "Check if the attribute is defined as readonly in the model. Readonly attributes can only be set when creating a new record.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_migration_missing",
      "pattern": "ActiveRecord::PendingMigrationError",
      "type": "ActiveRecord::PendingMigrationError",
      "description": "Database schema has pending migrations",
      "root_cause": "activerecord_pending_migration",
      "suggestion": "Run 'rails db:migrate' to apply pending migrations to your database.",
      "confidence": "high",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_schema_mismatch",
      "pattern": "ActiveRecord::StatementInvalid: (?:PG::)?UndefinedTable: ERROR:.*relation \"([^\"]+)\" does not exist",
      "type": "ActiveRecord::StatementInvalid",
      "description": "Table doesn't exist in the database",
      "root_cause": "activerecord_undefined_table",
      "suggestion": "Make sure migrations have been run. Check for typos in table names. Ensure the database schema matches the application's expectations.",
      "confidence": "high",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_connection_pool_timeout",
      "pattern": "ActiveRecord::ConnectionTimeoutError: could not obtain a (?:database )?connection within (\\d+\\.?\\d*) seconds",
      "type": "ActiveRecord::ConnectionTimeoutError",
      "description": "Database connection pool exhausted",
      "root_cause": "activerecord_connection_pool_timeout",
      "suggestion": "Increase the connection pool size in database.yml. Ensure connections are properly released after use.",
      "confidence": "high",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_record_not_saved",
      "pattern": "ActiveRecord::RecordNotSaved",
      "type": "ActiveRecord::RecordNotSaved",
      "description": "Record could not be saved",
      "root_cause": "activerecord_record_not_saved",
      "suggestion": "Check for validation errors or database constraints. Use save! to raise specific validation errors.",
      "confidence": "medium",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_value_too_long",
      "pattern": "ActiveRecord::StatementInvalid:.*(?:PG::)?StringDataRightTruncation|value too long for type",
      "type": "ActiveRecord::StatementInvalid",
      "description": "String value exceeds column length limit",
      "root_cause": "activerecord_value_too_long",
      "suggestion": "Add length validation to your model to match database column constraints. Consider increasing the column size in a migration.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_invalid_foreign_key",
      "pattern": "ActiveRecord::InvalidForeignKey",
      "type": "ActiveRecord::InvalidForeignKey",
      "description": "Foreign key constraint violation",
      "root_cause": "activerecord_invalid_foreign_key",
      "suggestion": "Ensure the referenced record exists before creating or updating the record. Check cascading delete settings for associated records.",
      "confidence": "high",
      "severity": "high",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_eager_load_error",
      "pattern": "ActiveRecord::EagerLoadPolymorphicError",
      "type": "ActiveRecord::EagerLoadPolymorphicError",
      "description": "Attempted to eager load a polymorphic association",
      "root_cause": "activerecord_eager_load_polymorphic",
      "suggestion": "Polymorphic associations cannot be eager-loaded with includes or preload. Use the each_with_object pattern or separate queries for each association type.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    },
    {
      "id": "activerecord_attribute_type_mismatch",
      "pattern": "ActiveRecord::AttributeTypeMismatch",
      "type": "ActiveRecord::AttributeTypeMismatch",
      "description": "Assigned value type doesn't match column type",
      "root_cause": "activerecord_attribute_type_mismatch",
      "suggestion": "Ensure the value type matches the column type. Use type conversion methods (to_i, to_s, etc.) if necessary.",
      "confidence": "high",
      "severity": "medium",
      "category": "activerecord",
      "framework": "rails"
    }
  ]
}